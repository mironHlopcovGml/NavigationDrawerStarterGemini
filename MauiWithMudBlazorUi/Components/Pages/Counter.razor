@page "/counter"

@using MauiAppWithMudBlazor.Components.Models
@using EfcToXamarinAndroid.Core.Repository
@using EfcToXamarinAndroid.Core
@using EfcToXamarinAndroid.Core.ViewModels
@using EfcToXamarinAndroid.Core.Services
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject MainViewModel VM
@inject ISmsReader SmsReader
@inject IFileService FileService

<div class="page-layout">

    @* --- СЛОЙ 1: Статистика (Закреплена сзади) --- *@
    <div class="backdrop-header">
        @if (TabsOnTop)
        {
            <MudTabs Centered="true" Color="Color.Primary" Elevation="0" ActivePanelIndexChanged="TabChangedAsync">
                <MudTabPanel Icon="@Icons.Material.Filled.List" />
                <MudTabPanel Icon="@Icons.Material.Filled.Payment" />
                <MudTabPanel Icon="@Icons.Material.Filled.AccountBalance" />
                <MudTabPanel Icon="@Icons.Material.Filled.AttachMoney" />
                <MudTabPanel Icon="@Icons.Material.Filled.QuestionMark" />
            </MudTabs>
        }

        <div class="stats-content px-2 py-2" style="height: 100%;">
            <MudCarousel Class="stats-carousel "
                         @bind-SelectedIndex="selectedIndex"
                         ShowArrows="false"
                         ShowBullets="false"
                         AutoCycle="false"
                         TData="object"
                         Style="height: 100%;">

                @* СЛАЙД 1: Общие цифры (Баланс, Средний, Мин/Макс) *@
                <MudCarouselItem Transition="Transition.Slide">
                    <div class="d-flex flex-column justify-center align-center h-100 pa-2">
                        <MudText Typo="Typo.h4" Style="font-weight:bold;">@VM.FiltredTransactionsSumm.ToString("C0")</MudText>
                        <MudText Typo="Typo.caption" Class="mb-4">Общая сумма (@VM.FiltredTransactionsCount оп.)</MudText>

                        <MudGrid Class="w-100">
                            <MudItem xs="4" Class="text-center">
                                <MudText Typo="Typo.caption">Средний</MudText>
                                <MudText Typo="Typo.subtitle2">@VM.CurrentStats.AverageCheck.ToString("N0")</MudText>
                            </MudItem>
                            <MudItem xs="4" Class="text-center">
                                <MudText Typo="Typo.caption">Макс.</MudText>
                                <MudText Typo="Typo.subtitle2" Color="Color.Success">@VM.CurrentStats.MaxSum.ToString("N0")</MudText>
                            </MudItem>
                            <MudItem xs="4" Class="text-center">
                                <MudText Typo="Typo.caption">Мин.</MudText>
                                <MudText Typo="Typo.subtitle2" Color="Color.Error">@VM.CurrentStats.MinSum.ToString("N0")</MudText>
                            </MudItem>
                        </MudGrid>
                    </div>
                </MudCarouselItem>

                @* СЛАЙД 2: График по дням *@
                <MudCarouselItem Transition="Transition.Slide">
                    <div class="d-flex flex-column align-center justify-center h-100 pa-2">
                        <MudText Typo="Typo.caption">Динамика операций (кол-во)</MudText>
                        @if (VM.CurrentStats.DailyChartData.Length > 0)
                        {
                            <MudChart ChartType="ChartType.Bar"
                                      ChartSeries="@(new List<ChartSeries>() { new ChartSeries() { Name = "Операции", Data = VM.CurrentStats.DailyChartData } })"
                                      XAxisLabels="@VM.CurrentStats.DailyChartLabels"
                                      Width="100%"
                                      Height="140px"
                                      LegendPosition="Position.Bottom" />
                        }
                        else
                        {
                            <MudText>Нет данных для графика</MudText>
                        }
                    </div>
                </MudCarouselItem>

                @* СЛАЙД 3: Топ категорий *@
                <MudCarouselItem Transition="Transition.Slide">
                    <div class="d-flex flex-column justify-center h-100 pa-2">
                        <MudText Typo="Typo.caption" Class="mb-1 text-center">Топ 5 категорий</MudText>
                        @foreach (var cat in VM.CurrentStats.TopCategories)
                        {
                            <div class="d-flex justify-space-between align-center mb-1">
                                <MudText Typo="Typo.caption" Style="width: 40%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@cat.Name</MudText>
                                <MudProgressLinear Color="Color.Secondary" Value="@cat.Percentage" Class="mx-2" Style="width: 30%;" />
                                <MudText Typo="Typo.caption" Style="width: 30%; text-align: right;">@cat.Amount.ToString("N0") (@cat.Percentage.ToString("F0")%)</MudText>
                            </div>
                        }
                    </div>
                </MudCarouselItem>

                @* СЛАЙД 4: Аномалии *@
                <MudCarouselItem Transition="Transition.Slide">
                    <div class="d-flex flex-column justify-center h-100 pa-2">
                        <MudText Typo="Typo.caption" Class="mb-2 text-center">Топ 3 выброса (Max)</MudText>
                        @foreach (var item in VM.CurrentStats.Anomalies)
                        {
                            <div class="d-flex justify-space-between align-center py-1 border-b" style="border-color: rgba(255,255,255,0.2);">
                                <div class="d-flex flex-column">
                                    <MudText Typo="Typo.body2">@item.Description</MudText>
                                    <MudText Typo="Typo.caption" Style="opacity:0.7">@item.Date.ToString("dd MMM")</MudText>
                                </div>
                                <MudText Typo="Typo.body2" Style="font-weight:bold;">@item.Sum.ToString("N0")</MudText>
                            </div>
                        }
                    </div>
                </MudCarouselItem>

            </MudCarousel>

        </div>
    </div>

    @* --- СЛОЙ 2: Скроллящаяся область (Лежит поверх статистики) --- *@
    <div id="scroll-area" class="scroll-layer" @key="activeTabIndex">

        <div class="header-spacer">
            <MudSwipeArea OnSwipeEnd="SwipeEndAsync" Class="stats-carousel" />
            <div class="edge-hint left @(showLeftHint ? "show" : "")"></div>
            <div class="edge-hint right @(showRightHint ? "show" : "")"></div>
        </div>


        <MudPaper Class="content-sheet rounded-t-xl" Elevation="4">

            @if (VM.AllItems.Count == 0)
            {
                <div class="pa-4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="50px" Class="mb-4" />
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" />
                </div>
            }
            else
            {
                <Virtualize @ref="_virtualizeComponent" ItemsProvider="LoadFinanceItems"
                            ItemSize="72"
                            OverscanCount="20">
                    <ItemContent Context="item">
                        <MyTItem @key="item.Id"
                                 TItem="FinanceItem"
                                 Item="@item"
                                 ItemTitle="@item.DisplayTitle"
                                 ItemLabel="@item.DisplayDescription"
                                 infoTitle="@item.FormattedSum"
                                 infoTitleColor="@item.AmountColor"
                                 infoLabel=@($"{item.FormattedTime}\n{item.FormattedDate}")
                                 OnItemClick="ItemClicked" />
                        <MudDivider />
                    </ItemContent>
                    <Placeholder>
                        <div class="pa-4 text-center">Загрузка...</div>
                    </Placeholder>
                </Virtualize>
            }

            <div style="height: 80px;"></div>
        </MudPaper>

        <MudScrollToTop Selector="#scroll-area" Style="bottom: 80px; right: 20px;">
            <MudFab Color="Color.Secondary" Size="Size.Small" StartIcon="@Icons.Material.Filled.ArrowUpward" />
        </MudScrollToTop>

        @* === Кнопка "наверх" от MudBlazor === *@
        <MudScrollToTop Selector="#scroll-area" style="bottom:60px; right:40px;">
            <MudFab Color="Color.Primary"
                    StartIcon="@Icons.Material.Filled.KeyboardArrowUp"
                    style="opacity: 0.7;" />
        </MudScrollToTop>
    </div>

    @* --- СЛОЙ 3: Нижние табы (Всегда поверх всего) --- *@
    <div class="bottom-tabs">
        <MudTabs Centered="true"
                 Position="Position.Bottom"
                 Elevation="8"
                 Color="Color.Surface"
                 ApplyEffectsToContainer="true"
                 MinimumTabWidth="9px"
                 ActivePanelIndexChanged="TabChangedAsync">
            <MudTabPanel Icon="@Icons.Material.Filled.List" />
            <MudTabPanel Icon="@Icons.Material.Filled.Payment" />
            <MudTabPanel Icon="@Icons.Material.Filled.AccountBalance" />
            <MudTabPanel Icon="@Icons.Material.Filled.AttachMoney" />
            <MudTabPanel Icon="@Icons.Material.Filled.QuestionMark" />
        </MudTabs>
    </div>

</div>

<style>
    /* Переменная для высоты "шапки" со статистикой.
                   Если добавите табы сверху, увеличьте это значение (например, до 180px) */
    :root {
        --header-height: 220px;
        --tab-panel-height: 48px
    }

    .page-layout {
        position: relative;
        height: calc(100vh - var(--mud-appbar-height) + 1rem);
        overflow: hidden;
        /* background-color: var(--mud-palette-primary); */
    }

    /* СЛОЙ 1: Статистика */
    .backdrop-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        z-index: 1; /* Самый нижний слой */
        color: white;
        pointer-events: auto;
    }

    .stats-carousel {
        height: 100%;
        background: transparent;
    }

    /* СЛОЙ 2: Область скролла */
    .scroll-layer {
        position: absolute;
        top: 0;
        bottom: 0; /* Растягиваем на всю высоту */
        left: 0;
        right: 0;
        overflow-y: auto; /* Скролл происходит здесь */
        height: calc(100vh - var(--mud-appbar-height) - var(--tab-panel-height) + 1rem);
        z-index: 2; /* Слой выше статистики */
        -webkit-overflow-scrolling: touch; /* Плавный скролл на iOS */
        pointer-events: auto;
    }


    /* Прозрачный блок, через который видно статистику */
    .header-spacer {
        height: var(--header-height);
        width: 100%;
        pointer-events: auto; /* ← главное свойство */
        position: relative;
    }


    /* Сам белый лист */
    .content-sheet {
        background-color: var(--mud-palette-surface);
        min-height: calc(100% - var(--header-height)); /* Чтобы заполнить экран */
        position: relative;
        box-shadow: 0px -4px 15px rgba(0,0,0,0.2);
        pointer-events: auto;
        /*  overflow: hidden; /* чтобы скролл-контент не ломал радиус */ */
    }

    /* СЛОЙ 3: Нижние табы */
    .bottom-tabs {
        position: absolute;
        height: var(--tab-panel-height);
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10; /* Поверх всего */
    }

    .edge-hint {
        position: absolute;
        top: 0;
        height: 100%;
        width: 24px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease-out;
    }

        .edge-hint.left {
            left: 0;
            background: linear-gradient(to right, rgba(255,255,255,0.25), transparent);
        }

        .edge-hint.right {
            right: 0;
            background: linear-gradient(to left, rgba(255,255,255,0.25), transparent);
        }

        .edge-hint.show {
            opacity: 1;
        }


</style>

@code {
    private int selectedIndex = 0;
    private bool showLeftHint;
    private bool showRightHint;
    // Ваш существующий C# код остается без изменений...
    // ...
    private Virtualize<FinanceItem>? _virtualizeComponent;
    private int activeTabIndex = 0;
    private bool TabsOnTop = false;
    private ElementReference scrollRef;
    private readonly DialogOptions _fullScreen = new() { FullScreen = true };
    private IEnumerable<FinanceItem> curentItems = Enumerable.Empty<FinanceItem>();

    protected override async Task OnInitializedAsync()
    {
        VM.DataUpdated += async (_, __) => await InvokeAsync(StateHasChanged);
        VM.DataFiltred += async (_, __) => await FilterChangedAsync();
        await Task.Yield();

        await InvokeAsync(async () =>
        {
            await VM.InitializeAsync();
            var granted = await VM.CheckPermissionsAsync();
            if (granted)
            {
                var cfg = EfcToXamarinAndroid.Core.Configs.ManagerCore.ConfigurationManager.ConfigManager.BankConfigurationFromJson;
                SmsReader.StartListening(cfg.Banks);
                await VM.ProcessSmsDataAsync();
            }

            await TabChangedAsync(0);
        });
    }
    public void Dispose()
    {
        VM.Dispose();
    }

    private IEnumerable<FinanceItem> GetActiveItems()
    {
        return activeTabIndex switch
        {
            0 => VM.GetFilteredItems(OperacionTyps.None),
            1 => VM.GetFilteredItems(OperacionTyps.OPLATA),
            2 => VM.GetFilteredItems(OperacionTyps.NALICHNYE),
            3 => VM.GetFilteredItems(OperacionTyps.ZACHISLENIE),
            4 => VM.GetFilteredItems(OperacionTyps.UNREACHABLE),
            _ => Enumerable.Empty<FinanceItem>()
        };
    }

    private async Task ItemClicked(FinanceItem item)
    {
        var parameters = new DialogParameters<FullScreenFinItemDialog> { { x => x.Item, item.ThisFinanceItem }, { x => x.VM, VM } };
        var dialog = await DialogService.ShowAsync<FullScreenFinItemDialog>("Details", parameters, _fullScreen);
        await dialog.Result;
    }

    private async ValueTask<ItemsProviderResult<FinanceItem>> LoadFinanceItems(ItemsProviderRequest request)
    {
        var items = curentItems
            .Skip(request.StartIndex)
            .Take(request.Count)
            .ToList();
        return new ItemsProviderResult<FinanceItem>(items, curentItems.Count());
    }

    private async Task TabChangedAsync(int index)
    {
        activeTabIndex = index;
        curentItems = GetActiveItems();
        await InvokeAsync(StateHasChanged);
    }

    private async Task FilterChangedAsync()
    {
        curentItems = GetActiveItems();
        if (_virtualizeComponent != null)
            await _virtualizeComponent.RefreshDataAsync();
        await InvokeAsync(StateHasChanged);
    }
    private void SwipeEndAsync(SwipeEventArgs args)
    {
        int maxIndex = 3; // у тебя 4 слайда: 0..3

        if (args.SwipeDirection == SwipeDirection.RightToLeft)
        {
            if (selectedIndex >= maxIndex)
            {
                showRightHint = true;
                _ = HideHintAsync(isRight: true);
                return;
            }
            selectedIndex++;
        }

        if (args.SwipeDirection == SwipeDirection.LeftToRight)
        {
            if (selectedIndex <= 0)
            {
                showLeftHint = true;
                _ = HideHintAsync(isRight: false);
                return;
            }
            selectedIndex--;
        }
    }
    private async Task HideHintAsync(bool isRight)
    {
        await Task.Delay(250);
        if (isRight) showRightHint = false;
        else showLeftHint = false;
        await InvokeAsync(StateHasChanged);
    }
}