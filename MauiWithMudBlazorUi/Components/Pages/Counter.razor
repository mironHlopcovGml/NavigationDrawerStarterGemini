@page "/counter"
@using MauiAppWithMudBlazor.Components.Models
@using EfcToXamarinAndroid.Core.Repository
@using EfcToXamarinAndroid.Core
@using EfcToXamarinAndroid.Core.ViewModels
@using EfcToXamarinAndroid.Core.Services
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject MainViewModel VM
@inject ISmsReader SmsReader
@inject IFileService FileService


@if (VM.AllItems.Count == 0)
{
    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="64px" Width="100%" />
    @for (int i = 0; i < 5; i++)
    {
        <MudCard>
            <MudCardHeader>
                <CardHeaderAvatar>
                    <MudSkeleton SkeletonType="SkeletonType.Circle" Width="50px" Height="50px" />
                </CardHeaderAvatar>
                <CardHeaderContent>
                    <MudSkeleton />
                    <MudSkeleton Animation="Animation.False" />
                    <MudSkeleton Animation="Animation.Wave" />
                </CardHeaderContent>
            </MudCardHeader>
        </MudCard>
        <MudDivider />
    }
}
else
{
    <MudScrollToTop TopOffset="100"
                    OnScroll="OnScroll"
                    Selector="#unique_id_scroll_section"
                    VisibleCssClass="visible absolute"
                    HiddenCssClass="invisible">
        <span class="mud-scroll-to-top @scrolVisible" @onclick="OnFabButtonClick" style="z-index:2001;">
            <button type="button" class=" @scrolVisible mud-button-root mud-fab mud-fab-primary mud-fab-size-large mud-ripple" _bl_67>
                <span class="mud-fab-label @scrolVisible">
                    <svg class="mud-icon-root mud-svg-icon mud-icon-size-medium" focusable="false" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z">
                        </path>
                    </svg>
                </span>
            </button>
        </span>
    </MudScrollToTop>
    <MudTabs KeepPanelsAlive="true" Position="Position.Bottom" Elevation="0">
        <MudTabPanel Text="Tab One" Style="width:100%">
            <MudTable id="unique_id_scroll_section" style="@tableStyle" T="FinanceItem" Items="VM.AllItems" Virtualize="true" Hover="true" OnRowClick="RowClickEvent" OverscanCount="16">
                <RowTemplate>
                    <MyItem Icon="@GetIconForOperation(context.OperationType.ToString())"
                            ItemTitle="@context.DisplayTitle"
                            ItemLabel="@context.DisplayDescription"
                            infoTitle="@context.FormattedSum"
                            infoLabel=@($"{@context.FormattedTime}\n{@context.FormattedDate}") />
                </RowTemplate>
            </MudTable>

        </MudTabPanel>
    </MudTabs>
}


@code {
    private bool isInitialized = false;
    private List<FinanceItem> financeItems = new List<FinanceItem>();
    private int activeTabIndex = 0;
    private string tableStyle = "height:calc(100vh - 98px); overflow-y:auto;";
    private readonly DialogOptions _fullScreen = new() { FullScreen = true };
    private string scrolVisible = string.Empty;

    private readonly Dictionary<OperacionTyps, List<FinanceItem>> filteredCache = new();


    protected override async Task OnInitializedAsync()
    {
        VM.DataUpdated += async (_, __) => await InvokeAsync(StateHasChanged);
        await Task.Yield(); // даст UI возможность отрендериться
        _ = Task.Run(async () =>
        {
            await VM.InitializeAsync();
            var granted = await VM.CheckPermissionsAsync();
            if (granted)
            {
                var cfg = EfcToXamarinAndroid.Core.Configs.ManagerCore.ConfigurationManager.ConfigManager.BankConfigurationFromJson;
                SmsReader.StartListening(cfg.Banks);
                await VM.ProcessSmsDataAsync();
            }
            await InvokeAsync(StateHasChanged);
        });


#if ANDROID
   // tableStyle = string.Empty;
#endif

        MessagingCenter.Subscribe<MainPage, string>(this, "ShowToTop", (sender, args) =>
        {
            scrolVisible = args;
            StateHasChanged();
        });
       
    }

   

    private async Task RowClickEvent(TableRowClickEventArgs<FinanceItem> tableRowClickEventArgs)
    {
        var item = tableRowClickEventArgs.Item;
        var message = $"Операция: {item.DisplayTitle}\nСумма: {item.FormattedSum}\nДата: {item.FormattedDate}\nОписание: {item.DisplayDescription}";

        // Можно добавить диалог с деталями операции
        System.Diagnostics.Debug.WriteLine(message);
    }

  

    private void OnScroll(ScrollEventArgs e)
    {
        scrolVisible = (e.FirstChildBoundingClientRect.Top * -1) switch
        {
            var x when x > 1 => "visible",
            _ => "hiden"
        };
    }

    void OnFabButtonClick()
    {
        JSRuntime.InvokeVoidAsync("scrollToTop");
        scrolVisible = string.Empty;
    }


    private string GetIconForOperation(string operationType)
    {
        return operationType switch
        {
            "OPLATA" => Icons.Material.Filled.Payment,
            "ZACHISLENIE" => Icons.Material.Filled.AccountBalance,
            "NALICHNYE" => Icons.Material.Filled.AttachMoney,
            "UNREACHABLE" => Icons.Material.Filled.QuestionMark,
            _ => Icons.Material.Filled.Payment
        };
    }
}
